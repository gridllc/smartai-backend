<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartAI</title>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>
  <h1>SmartAI Audio Transcriber</h1>

  <div id="authBox" style="display: none;">
    <input type="text" id="loginUser" placeholder="Username" />
    <input type="password" id="loginPass" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p>or <a href="#" onclick="showRegister()">Register</a></p>
  </div>

  <div id="registerBox" style="display:none">
    <input type="text" id="regUser" placeholder="Username" />
    <input type="text" id="regName" placeholder="Full Name" />
    <input type="password" id="regPass" placeholder="Password" />
    <input type="text" id="regCode" placeholder="Invite Code" />
    <button onclick="register()">Submit</button>
    <p><a href="#" onclick="cancelRegister()">Cancel</a></p>
  </div>

  <div id="appBox" style="display:none">
    <span id="greeting"></span>
    <button onclick="logout()">Logout</button>
    <button onclick="showChangePass()">Change Password</button>
    <button onclick="getInviteCode()">Generate Invite (Admin)</button>

    <div id="changePassBox" style="display:none">
      <input type="password" id="oldPass" placeholder="Old Password" />
      <input type="password" id="newPass" placeholder="New Password" />
      <button onclick="changePassword()">Change</button>
      <button onclick="hideChangePass()">Cancel</button>
    </div>

    <hr>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload & Transcribe</button>
    <div id="transcriptHistory"></div>
    <hr>
    <h2>Ask a Question</h2>
    <input type="text" id="questionInput" placeholder="Ask a question..." />
    <button onclick="askQuestion()">Ask</button>
    <div id="answerBox"><pre id="answerText"></pre></div>
  </div>

  <script>
    const BASE_URL = "https://smartai-transcriber.onrender.com";

    window.onload = () => {
      const token = localStorage.getItem("token");
      if (!token) {
        document.getElementById("authBox").style.display = "block";
        document.getElementById("appBox").style.display = "none";
      } else {
        document.getElementById("authBox").style.display = "none";
        document.getElementById("appBox").style.display = "block";
        document.getElementById("greeting").innerText = `ðŸ‘‹ Welcome, ${localStorage.getItem("username")}`;
        loadHistory();
      }
    };

    function showToast(msg, type = 'info') {
      const colors = { success: '#4CAF50', error: '#f44336', info: '#2196F3' };
      Toastify({ text: msg, duration: 3000, gravity: 'top', position: 'right', backgroundColor: colors[type] }).showToast();
    }

    function showRegister() {
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('registerBox').style.display = 'block';
    }

    function cancelRegister() {
      document.getElementById('registerBox').style.display = 'none';
      document.getElementById('authBox').style.display = 'block';
    }

    async function register() {
      const body = {
        username: document.getElementById('regUser').value,
        full_name: document.getElementById('regName').value,
        password: document.getElementById('regPass').value,
        invite_code: document.getElementById('regCode').value
      };
      try {
        const res = await fetch(`${BASE_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Registration failed');
        showToast("Registered successfully!", "success");
        cancelRegister();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function login() {
      const user = document.getElementById("loginUser").value;
      const pass = document.getElementById("loginPass").value;
      const body = `username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`;
      try {
        const res = await fetch(`${BASE_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail);
        localStorage.setItem('token', data.access_token);
        localStorage.setItem('username', user);
        document.getElementById("authBox").style.display = "none";
        document.getElementById("appBox").style.display = "block";
        document.getElementById("greeting").innerText = `ðŸ‘‹ Welcome, ${user}`;
        loadHistory();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    function showChangePass() {
      document.getElementById('changePassBox').style.display = 'block';
    }

    function hideChangePass() {
      document.getElementById('changePassBox').style.display = 'none';
    }

    async function changePassword() {
      const old_password = document.getElementById('oldPass').value;
      const new_password = document.getElementById('newPass').value;
      const res = await fetch(`${BASE_URL}/change-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({ old_password, new_password })
      });
      const data = await res.json();
      if (!res.ok) return showToast(data.detail || 'Error', 'error');
      showToast("Password changed!", "success");
      hideChangePass();
    }

    async function getInviteCode() {
      const res = await fetch(`${BASE_URL}/invite`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
      });
      const data = await res.json();
      if (!res.ok) return showToast(data.detail || 'Failed', 'error');
      navigator.clipboard.writeText(data.invite_code);
      showToast(`Invite copied: ${data.invite_code}`, 'info');
    }

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return showToast("Select a file", 'error');
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch(`${BASE_URL}/upload-and-transcribe`, {
        method: "POST",
        headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        body: formData
      });
      if (res.ok) {
        showToast("Uploaded", 'success');
        loadHistory();
      } else {
        showToast("Failed to upload", 'error');
      }
    }

    async function loadHistory() {
      try {
        const res = await fetch(`${BASE_URL}/api/history`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        const data = await res.json();
        const div = document.getElementById("transcriptHistory");
        div.innerHTML = "<h3>Transcript History</h3>";
        data.files.forEach(filename => {
          const item = document.createElement("div");
          item.innerText = filename;
          div.appendChild(item);
        });
      } catch (err) {
        showToast("Failed to load history", 'error');
        console.error(err);
      }
    }

    async function askQuestion() {
      const q = document.getElementById("questionInput").value;
      const res = await fetch(`${BASE_URL}/ask`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({ question: q })
      });
      const data = await res.json();
      document.getElementById("answerText").innerText = data.answer || 'No response.';
    }
  </script>
</body>
</html>
