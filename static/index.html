<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartAI Audio Transcriber</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body.dark {
            background-color: #111;
            color: #eee;
        }

        .dark input,
        .dark button {
            background-color: #222;
            color: #fff;
            border-color: #555;
        }

        .dark .profile-box,
        .dark .source-block {
            background-color: #333;
            border-color: #555;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #555;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #answerText {
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.5;
        }

        .source-block {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #aaa;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 0.9em;
        }

        .source-text {
            margin-top: 5px;
            color: #333;
            cursor: pointer;
        }

        .history-item {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        .history-item button {
            margin-left: 10px;
        }

        #logout,
        #darkToggle,
        #profileToggle,
        #analyticsToggle {
            float: right;
            margin-left: 10px;
        }

        #adminPanel,
        #walkthroughPanel,
        #analyticsPanel {
            margin-top: 20px;
            border: 1px solid #aaa;
            padding: 10px;
            display: none;
        }

        #activityLog {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }

        #walkthroughContent {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .profile-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            min-width: 300px;
        }

        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .profile-box h3 {
            margin-top: 0;
        }

        .profile-box input,
        .profile-box label {
            display: block;
            margin: 10px 0;
        }

        .profile-box input[type="text"],
        .profile-box input[type="email"] {
            width: 100%;
            padding: 8px;
        }

        .profile-box input[type="checkbox"] {
            display: inline-block;
            margin-right: 8px;
        }

        .profile-actions {
            margin-top: 15px;
        }

        .profile-actions button {
            margin-right: 10px;
        }

        .tag-input {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .tags-display {
            margin-top: 5px;
        }

        .tag-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .analytics-section {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .dark .analytics-section {
            background: #333;
            border-color: #555;
        }

        .analytics-stat {
            display: inline-block;
            margin: 5px 10px;
            padding: 5px;
            background: #e9ecef;
            border-radius: 3px;
        }

        .dark .analytics-stat {
            background: #444;
        }
    </style>
</head>

<body>
    <!-- Profile Overlay -->
    <div class="profile-overlay" id="profileOverlay" onclick="toggleProfile()"></div>

    <!-- Profile Box -->
    <div class="profile-box" id="profileBox">
        <h3>Profile Settings</h3>
        <label for="displayName">Display Name:</label>
        <input type="text" id="displayName" placeholder="Enter your display name" />

        <label>
            <input type="checkbox" id="prefDark" /> Prefer Dark Mode
        </label>

        <label>
            <input type="checkbox" id="emailNotifications" /> Email Notifications
        </label>

        <div class="profile-actions">
            <button onclick="saveProfile()">Save Profile</button>
            <button onclick="toggleProfile()">Cancel</button>
        </div>
    </div>

    <!-- Login UI -->
    <div id="loginBox">
        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button onclick="login()">Login</button>
        <p>Need an account? <a href="#" onclick="showRegister()">Register here</a></p>
        <p><a href="#" onclick="showReset()">Forgot Password?</a></p>
    </div>

    <!-- Password Reset UI -->
    <div id="resetBox" style="display:none">
        <h2>Reset Password</h2>
        <input type="email" id="resetEmail" placeholder="Email" />
        <input type="password" id="newPassword" placeholder="New Password" />
        <input type="text" id="resetCode" placeholder="Invite Code" />
        <button onclick="resetPassword()">Reset Password</button>
        <p><a href="#" onclick="showLogin()">Back to Login</a></p>
    </div>

    <!-- Registration UI -->
    <div id="registerBox" style="display:none">
        <h2>Register</h2>
        <input type="text" id="registerName" placeholder="Full Name" />
        <input type="email" id="registerEmail" placeholder="Email" />
        <input type="password" id="registerPassword" placeholder="Password" />
        <input type="text" id="registerCode" placeholder="Invite Code" />
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Go to login</a></p>
    </div>

    <!-- Main App UI -->
    <div id="appUI" style="display: none">
        <button id="logout" onclick="logout()">Logout</button>
        <button id="darkToggle" onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
        <button id="profileToggle" onclick="toggleProfile()">ðŸ‘¤ Profile</button>
        <button id="analyticsToggle" onclick="toggleAnalytics()">ðŸ“Š Analytics</button>
        <h1 id="welcomeHeader">SmartAI Audio Transcriber</h1>
        <input type="file" id="fileInput" />
        <button onclick="uploadFile()">Upload & Transcribe</button>
        <button onclick="downloadAll()">ðŸ“¦ Download All</button>
        <button onclick="toggleWalkthrough()">ðŸŽ“ Walkthrough</button>
        <div>
            <input type="text" id="searchInput" placeholder="Search transcripts..." oninput="filterTranscripts()" />
            <input type="text" id="tagSearchInput" placeholder="Filter by tag..." oninput="filterTranscripts()" />
            <select id="sortSelect" onchange="filterTranscripts()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>
        </div>
        <div id="transcriptHistory"></div>
        <hr>
        <h2>Ask a Question</h2>
        <input type="text" id="questionInput" placeholder="Ask a question..." />
        <button onclick="askQuestion()">Ask</button>
        <div id="spinner" class="spinner" style="display: none;"></div>
        <div id="answerBox">
            <div id="answerText"></div>
            <div id="sourcesBox"></div>
        </div>

        <!-- Analytics Panel -->
        <div id="analyticsPanel">
            <h3>Analytics Dashboard</h3>
            <button onclick="loadAnalytics()">Refresh Analytics</button>
            <div id="analyticsContent"></div>
        </div>

        <div id="adminPanel">
            <h3>Admin Panel</h3>
            <p>This section is only visible to admin users.</p>
            <button onclick="loadActivityLog()">Refresh Activity Log</button>
            <div id="activityLog"></div>

            <h4>User Feedback</h4>
            <button onclick="loadFeedback()">Refresh Feedback</button>
            <div id="feedbackList" style="margin-top: 10px;"></div>
        </div>

        <!-- Walkthrough Panel -->
        <div id="walkthroughPanel">
            <h3>Walkthrough Mode</h3>
            <div id="walkthroughContent">
                <em>Loading...</em>
            </div>
        </div>

        <div id="feedbackPanel" style="margin-top: 20px;">
            <h3>Have Feedback?</h3>
            <textarea id="feedbackInput" placeholder="Tell us what you think..." rows="4"
                style="width: 100%"></textarea>
            <button onclick="submitFeedback()">Submit Feedback</button>
            <div id="feedbackStatus"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allTranscripts = [];

        function showToast(message, type = "info") {
            let bg = { success: "#4CAF50", error: "#f44336", info: "#2196F3" }[type] || "#333";
            Toastify({ text: message, duration: 3000, gravity: "top", position: "right", backgroundColor: bg }).showToast();
        }

        // Analytics Functions
        function toggleAnalytics() {
            const panel = document.getElementById("analyticsPanel");
            panel.style.display = panel.style.display === "none" ? "block" : "none";
            if (panel.style.display === "block") loadAnalytics();
        }

        async function loadAnalytics() {
            const contentBox = document.getElementById("analyticsContent");
            contentBox.innerHTML = "<p>Loading analytics...</p>";
            try {
                const res = await fetch("/api/admin/analytics", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed to fetch admin analytics');
                const data = await res.json();
                displayAnalytics(data);
                loadUploadsByDateChart();
            } catch (err) {
                console.error("Analytics load error:", err);
                contentBox.innerHTML = `<p>Error loading analytics: ${err.message}</p>`;
            }
        }

        function displayAnalytics(data) {
            const contentBox = document.getElementById("analyticsContent");
            contentBox.innerHTML = `
                <div class="analytics-section">
                  <h4>Overall Stats</h4>
                  <span class="analytics-stat"><strong>Total Users:</strong> ${data.total_users}</span>
                  <span class="analytics-stat"><strong>Total Files:</strong> ${data.total_files}</span>
                  <span class="analytics-stat"><strong>Total Qs:</strong> ${data.total_questions}</span>
                </div>
                <div class="analytics-section">
                  <h4>Top Users (by activity)</h4>
                  <canvas id="userActivityChart" height="150"></canvas>
                </div>
            `;
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.top_users.map(u => u.email),
                    datasets: [{
                        label: 'User Activity Count',
                        data: data.top_users.map(u => u.count),
                        backgroundColor: '#007BFF'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        async function loadUploadsByDateChart() {
            try {
                const res = await fetch("/api/admin/stats/uploads-by-date", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed to fetch date stats');

                const data = await res.json();
                const contentBox = document.getElementById("analyticsContent");

                const dateChartSection = document.createElement('div');
                dateChartSection.className = 'analytics-section';
                dateChartSection.innerHTML = `<h4>Uploads Per Day</h4>`;
                const canvas = document.createElement('canvas');
                canvas.id = 'uploadsByDateChart';
                canvas.height = 150;
                dateChartSection.appendChild(canvas);
                contentBox.appendChild(dateChartSection);

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Uploads per day',
                            data: data.map(d => d.count),
                            borderColor: '#28a745',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            } catch (err) {
                console.error("Date chart error:", err);
                showToast(`Error loading date chart: ${err.message}`, "error");
            }
        }

        // Walkthrough Function
        async function toggleWalkthrough() {
            const panel = document.getElementById("walkthroughPanel");
            const content = document.getElementById("walkthroughContent");
            panel.style.display = panel.style.display === "none" ? "block" : "none";

            if (panel.style.display === "block") {
                try {
                    content.innerHTML = "<em>Loading...</em>";
                    const res = await fetch("/api/qa-history", {
                        headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                    });
                    if (!res.ok) throw new Error("Failed to load Q&A history");
                    const data = await res.json();

                    if (!data.history || data.history.length === 0) {
                        content.innerHTML = "<p><em>No Q&A history found. Ask a question to see it here.</em></p>";
                        return;
                    }

                    content.innerHTML = data.history.map(q => `
                        <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ccc;">
                          <p><strong>Q:</strong> ${q.question}</p>
                          <p><strong>A:</strong> ${q.answer}</p>
                          <small><em>${new Date(q.timestamp).toLocaleString()}</em></small>
                        </div>
                    `).join("");

                } catch (err) {
                    content.innerHTML = `<p style="color:red;">Error loading history: ${err.message}</p>`;
                }
            }
        }

        // Tag Management Functions
        async function updateTag(filename, tag) {
            try {
                const res = await fetch(`/api/transcript/${filename}/tag`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + localStorage.getItem("accessToken")
                    },
                    body: JSON.stringify({ tag })
                });

                if (!res.ok) throw new Error("Failed to update tag");
                showToast("Tag updated successfully!", "success");
                loadHistory();
            } catch (err) {
                showToast("Error updating tag: " + err.message, "error");
            }
        }

        // Profile Management Functions
        function toggleProfile() {
            const box = document.getElementById("profileBox");
            const overlay = document.getElementById("profileOverlay");
            const isVisible = box.style.display === "block";
            box.style.display = isVisible ? "none" : "block";
            overlay.style.display = isVisible ? "none" : "block";
            if (!isVisible) loadProfile();
        }

        function loadProfile() {
            document.getElementById("displayName").value = localStorage.getItem("displayName") || "";
            document.getElementById("prefDark").checked = localStorage.getItem("prefDark") === "true";
            document.getElementById("emailNotifications").checked = localStorage.getItem("emailNotifications") === "true";
        }

        function saveProfile() {
            const displayName = document.getElementById("displayName").value;
            const prefDark = document.getElementById("prefDark").checked;
            const emailNotifications = document.getElementById("emailNotifications").checked;

            localStorage.setItem("displayName", displayName);
            localStorage.setItem("prefDark", prefDark.toString());
            localStorage.setItem("emailNotifications", emailNotifications.toString());

            if (prefDark) document.body.classList.add("dark");
            else document.body.classList.remove("dark");

            if (displayName) document.getElementById("welcomeHeader").innerText = `Welcome, ${displayName}`;

            showToast("Profile saved.", "success");
            toggleProfile();
        }

        function logout() {
            localStorage.clear();
            window.location.reload();
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark");
            localStorage.setItem("prefDark", document.body.classList.contains("dark"));
        }

        function showRegister() {
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("registerBox").style.display = "block";
            document.getElementById("resetBox").style.display = "none";
        }

        function showLogin() {
            document.getElementById("registerBox").style.display = "none";
            document.getElementById("loginBox").style.display = "block";
            document.getElementById("resetBox").style.display = "none";
        }

        function showReset() {
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("resetBox").style.display = "block";
        }

        async function resetPassword() {
            const email = document.getElementById("resetEmail").value;
            const password = document.getElementById("newPassword").value;
            const code = document.getElementById("resetCode").value;
            try {
                const res = await fetch("/reset-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password, code })
                });
                if (!res.ok) throw new Error("Reset failed");
                showToast("Password updated!", "success");
                showLogin();
            } catch (err) {
                showToast("Reset error: " + err.message, "error");
            }
        }

        async function downloadAll() {
            try {
                showToast("Preparing download...", "info");
                const response = await fetch("/api/download/all", {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!response.ok) throw new Error("Download failed");
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "all_transcripts.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showToast("Download started!", "success");
            } catch (err) {
                showToast("Download error: " + err.message, "error");
            }
        }

        async function loadActivityLog() {
            try {
                const res = await fetch("/api/activity-log", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error("Failed to load activity log");
                const data = await res.json();
                const logDiv = document.getElementById("activityLog");
                logDiv.innerHTML = "<h4>Recent Activity</h4><ul>" +
                    data.log.map(e => `<li>${e[1]} - ${e[2] || "(no file)"} by ${e[0]} @ ${new Date(e[3]).toLocaleString()}</li>`).join("") +
                    "</ul>";
            } catch (err) {
                showToast("Error loading activity log: " + err.message, "error");
            }
        }

        async function loadFeedback() {
            const box = document.getElementById("feedbackList");
            box.innerHTML = "<p><em>Loading feedback...</em></p>";
            try {
                const res = await fetch("/api/feedback", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error("Failed to load feedback");
                const data = await res.json();
                if (!data.length) {
                    box.innerHTML = "<p>No feedback found.</p>";
                    return;
                }
                box.innerHTML = data.map(fb =>
                    `<div style="padding: 10px; border-bottom: 1px solid #ccc;">` +
                    `<strong>${fb.email}</strong> - <em>${new Date(fb.timestamp).toLocaleString()}</em>` +
                    `<p>${fb.message}</p>` +
                    `</div>`
                ).join("");
            } catch (err) {
                box.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        async function submitFeedback() {
            const input = document.getElementById('feedbackInput');
            const status = document.getElementById('feedbackStatus');
            const message = input.value.trim();
            if (!message) {
                status.innerHTML = "<p style='color:red;'>Please write something.</p>";
                return;
            }
            try {
                const res = await fetch('/api/feedback', {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem("accessToken"),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(message)
                });
                if (!res.ok) throw new Error("Failed to submit feedback");
                input.value = '';
                status.innerHTML = "<p style='color:green;'>Feedback submitted. Thank you!</p>";
            } catch (err) {
                status.innerHTML = `<p style='color:red;'>Error: ${err.message}</p>`;
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return showToast("Please select a file to upload.", "error");

            const formData = new FormData();
            formData.append("file", file);
            const spinner = document.getElementById("spinner");
            spinner.style.display = "inline-block";

            try {
                const res = await fetch("/upload-and-transcribe", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") },
                    body: formData
                });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || "Upload failed");
                }
                showToast("Upload and transcription successful!", "success");
                loadHistory();
                fileInput.value = "";
            } catch (err) {
                showToast("Upload error: " + err.message, "error");
            } finally {
                spinner.style.display = "none";
            }
        }

        async function askQuestion() {
            const questionInput = document.getElementById("questionInput");
            const question = questionInput.value.trim();
            if (!question) return showToast("Please enter a question.", "error");

            const answerText = document.getElementById("answerText");
            const sourcesBox = document.getElementById("sourcesBox");
            answerText.textContent = "";
            sourcesBox.innerHTML = "";
            const spinner = document.getElementById("spinner");
            spinner.style.display = "inline-block";

            try {
                const response = await fetch("/ask", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + localStorage.getItem("accessToken")
                    },
                    body: JSON.stringify({ question })
                });

                if (!response.ok || !response.body) {
                    const errData = await response.json();
                    throw new Error(errData.detail || "Failed to get response from server.");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    for (const line of chunk.split("\n\n")) {
                        if (!line.startsWith("data:")) continue;
                        try {
                            const payload = JSON.parse(line.slice(5));
                            if (payload.type === "token") {
                                answerText.textContent += payload.data;
                            } else if (payload.type === "sources") {
                                payload.data.forEach(source => {
                                    const block = document.createElement("div");
                                    block.className = "source-block";
                                    block.innerHTML = `<strong>Source:</strong> ${source.source || "Unknown"}<div class='source-text'>${source.text}</div>`;
                                    sourcesBox.appendChild(block);
                                });
                            }
                        } catch (e) { console.error("Error parsing stream chunk:", line); }
                    }
                }
            } catch (err) {
                showToast("Error asking question: " + err.message, "error");
            } finally {
                spinner.style.display = "none";
                questionInput.value = "";
            }
        }

        function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            }).then(res => {
                if (!res.ok) throw new Error("Login failed");
                return res.json();
            }).then(data => {
                localStorage.setItem("accessToken", data.access_token);
                localStorage.setItem("userEmail", email);
                window.onload(); // Re-run init logic
                showToast("Login successful", "success");
            }).catch(err => {
                showToast("Login error: " + err.message, "error");
            });
        }

        function register() {
            const full_name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;
            const invite_code = document.getElementById("registerCode").value;
            fetch("/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password, full_name, invite_code })
            }).then(res => {
                if (!res.ok) throw new Error("Registration failed");
                return res.json();
            }).then(() => {
                showToast("Account created! Please login.", "success");
                showLogin();
            }).catch(err => {
                showToast("Registration error: " + err.message, "error");
            });
        }

        function filterTranscripts() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const tagQuery = document.getElementById("tagSearchInput").value.toLowerCase();
            const sortBy = document.getElementById("sortSelect").value;

            let filtered = allTranscripts.filter(item => {
                const name = (typeof item === 'string' ? item : item.filename).toLowerCase();
                const tag = (typeof item === 'object' && item.tag) ? item.tag.toLowerCase() : "";
                return name.includes(query) && (!tagQuery || tag.includes(tagQuery));
            });

            if (sortBy === "oldest") filtered.reverse();

            const historyDiv = document.getElementById("transcriptHistory");
            historyDiv.innerHTML = "<h3>Transcript History</h3>";
            if (filtered.length === 0) {
                historyDiv.innerHTML += "<p>No matching transcripts found.</p>";
            } else {
                filtered.forEach(item => renderTranscriptItem(item, historyDiv));
            }
        }

        function renderTranscriptItem(item, container) {
            const filename = typeof item === 'string' ? item : item.filename;
            const tag = typeof item === 'object' ? item.tag : null;
            const div = document.createElement("div");
            div.className = "history-item";
            const nameSpan = document.createElement("span");
            nameSpan.innerText = `ðŸ“„ ${filename}`;

            const tagInput = document.createElement("input");
            tagInput.type = "text";
            tagInput.className = "tag-input";
            tagInput.placeholder = "Add tag...";
            tagInput.value = tag || "";
            tagInput.onkeypress = (e) => { if (e.key === 'Enter') updateTag(filename, tagInput.value); };

            const tagButton = document.createElement("button");
            tagButton.innerText = "Tag";
            tagButton.onclick = () => updateTag(filename, tagInput.value);

            const tagsDisplay = document.createElement("div");
            tagsDisplay.className = "tags-display";
            if (tag) {
                const tagBadge = document.createElement("span");
                tagBadge.className = "tag-badge";
                tagBadge.innerText = tag;
                tagsDisplay.appendChild(tagBadge);
            }

            const previewBtn = document.createElement("button");
            previewBtn.innerText = "Preview";
            const shareBtn = document.createElement("button");
            shareBtn.innerText = "Share";
            shareBtn.onclick = () => {
                const link = `${window.location.origin}/static/view.html?file=${encodeURIComponent(filename)}`;
                navigator.clipboard.writeText(link);
                showToast("Shareable link copied!", "info");
            };

            const previewBox = document.createElement("div");
            previewBox.style.cssText = "display: none; margin-top: 5px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; white-space: pre-wrap; max-height: 200px; overflow-y: auto;";

            previewBtn.onclick = async () => {
                if (previewBox.style.display === "none") {
                    try {
                        previewBtn.innerText = "Loading...";
                        const res = await fetch(`/api/transcript/${filename}`, {
                            headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                        });
                        if (!res.ok) throw new Error("Failed to load transcript");
                        const data = await res.json();
                        previewBox.innerText = data.transcript || "[Empty]";
                        previewBox.style.display = "block";
                        previewBtn.innerText = "Hide Preview";
                    } catch (err) {
                        showToast("Error loading transcript: " + err.message, "error");
                        previewBtn.innerText = "Preview";
                    }
                } else {
                    previewBox.style.display = "none";
                    previewBtn.innerText = "Preview";
                }
            };

            const downloadBtn = document.createElement("button");
            downloadBtn.innerText = "Download";
            downloadBtn.onclick = () => { window.location.href = `/api/download/${filename}?token=${localStorage.getItem("accessToken")}`; };

            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "Delete";
            deleteBtn.onclick = async () => {
                if (confirm(`Are you sure you want to delete ${filename}?`)) {
                    try {
                        const res = await fetch(`/api/delete/${filename}`, {
                            method: "DELETE",
                            headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                        });
                        if (!res.ok) throw new Error("Delete failed");
                        loadHistory();
                        showToast(`${filename} deleted.`, "info");
                    } catch (err) {
                        showToast("Delete error: " + err.message, "error");
                    }
                }
            };

            div.appendChild(nameSpan);
            div.appendChild(tagInput);
            div.appendChild(tagButton);
            div.appendChild(previewBtn);
            div.appendChild(shareBtn);
            div.appendChild(downloadBtn);
            div.appendChild(deleteBtn);
            div.appendChild(tagsDisplay);
            div.appendChild(previewBox);

            container.appendChild(div);
        }

        async function loadHistory() {
            try {
                const res = await fetch("/api/history", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error("Failed to load history");
                const data = await res.json();
                allTranscripts = data.files || [];
                filterTranscripts();
            } catch (err) {
                showToast("Error loading history: " + err.message, "error");
            }
        }

        window.onload = () => {
            const token = localStorage.getItem("accessToken");
            if (token) {
                currentUser = localStorage.getItem("userEmail") || "user";
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("appUI").style.display = "block";

                const displayName = localStorage.getItem("displayName");
                document.getElementById("welcomeHeader").innerText = `Welcome, ${displayName || currentUser}`;

                if (currentUser === "patrick@gridllc.net") {
                    document.getElementById("adminPanel").style.display = "block";
                    document.getElementById("analyticsToggle").style.display = "inline-block";
                } else {
                    document.getElementById("analyticsToggle").style.display = "none";
                }

                if (localStorage.getItem("prefDark") === "true") {
                    document.body.classList.add("dark");
                }
                loadHistory();
            } else {
                document.getElementById("loginBox").style.display = "block";
                document.getElementById("appUI").style.display = "none";
                document.getElementById("registerBox").style.display = "none";
            }
        };
    </script>
</body>

</html>