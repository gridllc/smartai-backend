<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartAI Audio Transcriber</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body.dark {
            background-color: #111;
            color: #eee;
        }

        .dark input,
        .dark button,
        .dark textarea,
        .dark select {
            background-color: #222;
            color: #fff;
            border-color: #555;
        }

        .dark .profile-box,
        .dark .source-block,
        .dark #transcriptDetailPanel,
        .dark #transcriptPreviewBox,
        .dark .quiz-item,
        .dark #summaryContainer,
        .dark #quizViewPanel {
            background-color: #333;
            border-color: #555;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #555;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #answerText {
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.5;
        }

        .source-block {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #aaa;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 0.9em;
        }

        .history-item {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        .history-item button {
            margin-left: 10px;
        }

        #logout,
        #darkToggle,
        #profileToggle,
        #analyticsToggle {
            float: right;
            margin-left: 10px;
        }

        #transcriptDetailPanel {
            margin-top: 20px;
            border: 1px solid #aaa;
            padding: 15px;
            border-radius: 8px;
            background: #fdfdfd;
        }

        #transcriptPreviewBox {
            margin-top: 5px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f9f9f9;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            cursor: text;
        }

        .transcript-segment {
            padding: 4px 2px;
            margin-bottom: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        .transcript-segment:hover {
            background-color: #e9e9e9;
        }

        .transcript-segment.active {
            background-color: #cce5ff !important;
            font-weight: bold;
        }

        .dark .transcript-segment:hover {
            background-color: #444;
        }

        .dark .transcript-segment.active {
            background-color: #004085 !important;
            color: #fff;
        }

        .segment-editor {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        #summaryContainer {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f5f5f5;
        }

        #quizList {
            margin-top: 15px;
        }

        .quiz-item {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .quiz-item textarea {
            width: 100%;
            margin-bottom: 5px;
        }

        #quizViewPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        #quizViewContent {
            background: white;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <!-- Main App UI -->
    <div id="appUI" style="display: none">
        <!-- ... other UI elements like login, profile, etc. are assumed to be here ... -->

        <!-- Transcript Detail Panel -->
        <div id="transcriptDetailPanel" style="display: none;">
            <button onclick="closeTranscriptDetail()" style="float: right;">× Close</button>
            <h3 id="transcriptDetailFilename" style="margin-top:0;"></h3>

            <div id="detailControls" style="margin-bottom: 10px;">
                <button onclick="toggleEditSegments(this)">Edit Segments</button>
                <button onclick="toggleSummary()">Toggle Summary</button>
                <button onclick="generateFullQuiz()">Generate Full Quiz</button>
                <button onclick="toggleQuizPanel()">View Saved Quiz</button>
                <button onclick="exportTranscriptAsPDF()">Export to PDF</button>
            </div>

            <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px; display: none;"></audio>

            <h4>Transcript Content</h4>
            <div id="transcriptPreviewBox"></div>

            <div id="summaryContainer" style="display: none;">
                <h4>Summary</h4>
                <div id="summaryContent"><em>Loading summary...</em></div>
            </div>

            <div id="noteBox" style="margin-top: 20px;">
                <h4>Transcript Note</h4>
                <textarea id="noteInput" rows="4" style="width:100%;" placeholder="Add a note..."></textarea>
                <button onclick="saveNote()">Save Note</button>
            </div>

            <div id="quizList" style="margin-top: 20px; display:none;">
                <h4>Saved Quiz Questions</h4>
                <div id="quizContent"><em>Loading quiz...</em></div>
            </div>
        </div>

        <!-- ... other panels like admin, analytics, etc. ... -->
    </div>

    <!-- Quiz View Panel (Modal) -->
    <div id="quizViewPanel">
        <div id="quizViewContent">
            <button onclick="toggleQuizPanel()" style="float:right;">× Close</button>
            <h3 id="quizViewFilename">Quiz</h3>
            <div id="quizViewList"></div>
        </div>
    </div>

    <!-- All other HTML from your original file is assumed to be here (login box, profile box, etc.) -->
    <div class="profile-overlay" id="profileOverlay" onclick="toggleProfile()"></div>
    <div class="profile-box" id="profileBox">...</div>
    <div id="loginBox">...</div>
    <div id="resetBox" style="display:none">...</div>
    <div id="registerBox" style="display:none">...</div>
    <div id="appUI">
        <!-- The main UI from your file -->
        <button id="logout" onclick="logout()">Logout</button>
        <h1 id="welcomeHeader">SmartAI Audio Transcriber</h1>
        <input type="file" id="fileInput" />
        <button onclick="uploadFile()">Upload & Transcribe</button>
        <div id="transcriptHistory"></div>
        <hr>
        <h2>Ask a Question</h2>
        <input type="text" id="questionInput" placeholder="Ask a question..." />
        <button onclick="askQuestion()">Ask</button>
        <div id="spinner" class="spinner" style="display: none;"></div>
        <div id="answerBox">
            <div id="answerText"></div>
            <div id="sourcesBox"></div>
        </div>
        <!-- transcriptDetailPanel is here -->
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentUser = null;
        let allTranscripts = [];
        let editMode = false;
        let audioHighlightInterval = null;

        // --- CORE FUNCTIONS ---

        function showToast(message, type = "info") {
            let bg = { success: "#4CAF50", error: "#f44336", info: "#2196F3" }[type] || "#333";
            Toastify({ text: message, duration: 3000, gravity: "top", position: "right", backgroundColor: bg }).showToast();
        }

        async function loadTranscriptForDetailView(filename) {
            // Reset state
            closeTranscriptDetail();
            editMode = false;

            const panel = document.getElementById("transcriptDetailPanel");
            panel.style.display = "block";
            document.getElementById("transcriptDetailFilename").innerText = filename;
            const previewBox = document.getElementById("transcriptPreviewBox");
            const noteTextarea = document.getElementById("noteInput");
            const audioPlayer = document.getElementById("audioPlayer");

            previewBox.innerHTML = "<em>Loading transcript...</em>";
            noteTextarea.value = "";
            noteTextarea.dataset.filename = filename;
            audioPlayer.style.display = 'none';

            try {
                // Fetch transcript, note, and audio blob in parallel
                const [transcriptRes, noteRes, audioRes] = await Promise.all([
                    fetch(`/api/transcript/${filename}`, { headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") } }),
                    fetch(`/api/transcript/${filename}/note`, { headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") } }),
                    fetch(`/audio/${filename}`, { headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") } })
                ]);

                // --- Handle Transcript ---
                if (!transcriptRes.ok) throw new Error("Transcript load failed");
                const transcriptData = await transcriptRes.json();
                previewBox.innerHTML = "";
                if (transcriptData.segments && transcriptData.segments.length) {
                    transcriptData.segments.forEach(seg => {
                        const div = document.createElement("div");
                        div.className = "transcript-segment";
                        div.textContent = seg.text;
                        div.dataset.start = seg.start;
                        div.dataset.end = seg.end;
                        div.onclick = () => playSegmentFrom(seg.start);
                        previewBox.appendChild(div);
                    });
                } else {
                    previewBox.innerText = transcriptData.transcript || "[Empty]";
                }

                // --- Handle Audio ---
                if (audioRes.ok) {
                    const audioBlob = await audioRes.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    audioPlayer.onplay = startSegmentHighlighter;
                    audioPlayer.onpause = stopSegmentHighlighter;
                    audioPlayer.onended = stopSegmentHighlighter;
                }

                // --- Handle Note ---
                const noteData = noteRes.ok ? await noteRes.json() : { note: "" };
                noteTextarea.value = noteData.note || "";

            } catch (err) {
                showToast("Error loading details: " + err.message, "error");
                previewBox.innerHTML = `<p style="color:red;">Failed to load details.</p>`;
            }
        }

        function closeTranscriptDetail() {
            document.getElementById("transcriptDetailPanel").style.display = "none";
            document.getElementById("summaryContainer").style.display = "none";
            document.getElementById("quizList").style.display = "none";
            const audioPlayer = document.getElementById("audioPlayer");
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }
            stopSegmentHighlighter();
        }

        function renderTranscriptItem(item, container) {
            const filename = typeof item === 'string' ? item : item.filename;
            const div = document.createElement("div");
            div.className = "history-item";
            div.innerHTML = `<span>📄 ${filename}</span>`;

            const detailsBtn = document.createElement("button");
            detailsBtn.innerText = "View Details";
            detailsBtn.onclick = () => loadTranscriptForDetailView(filename);
            div.appendChild(detailsBtn);
            // Add other buttons like delete, share, etc. as needed
            container.appendChild(div);
        }

        // --- AUDIO & HIGHLIGHTING FUNCTIONS ---

        function playSegmentFrom(startTime) {
            const audioPlayer = document.getElementById("audioPlayer");
            audioPlayer.currentTime = startTime;
            audioPlayer.play();
        }

        function startSegmentHighlighter() {
            if (audioHighlightInterval) clearInterval(audioHighlightInterval);
            audioHighlightInterval = setInterval(highlightActiveSegment, 300);
        }

        function stopSegmentHighlighter() {
            if (audioHighlightInterval) clearInterval(audioHighlightInterval);
            audioHighlightInterval = null;
            document.querySelectorAll('.transcript-segment.active').forEach(el => el.classList.remove('active'));
        }

        function highlightActiveSegment() {
            const audioPlayer = document.getElementById("audioPlayer");
            const currentTime = audioPlayer.currentTime;
            const segments = document.querySelectorAll('#transcriptPreviewBox .transcript-segment');

            let activeSegment = null;
            segments.forEach(seg => {
                const start = parseFloat(seg.dataset.start);
                const end = parseFloat(seg.dataset.end);
                seg.classList.remove('active');
                if (currentTime >= start && currentTime <= end) {
                    activeSegment = seg;
                }
            });
            if (activeSegment) {
                activeSegment.classList.add('active');
            }
        }

        // --- SEGMENT EDITING & AI SUGGESTIONS ---

        function toggleEditSegments(button) {
            editMode = !editMode;
            const previewBox = document.getElementById("transcriptPreviewBox");
            const segments = previewBox.querySelectorAll('.transcript-segment, .segment-editor-wrapper');

            if (editMode) {
                button.textContent = "Save Edits";
                button.onclick = () => { saveEditedSegments(); };
                segments.forEach(seg => {
                    const text = seg.tagName === 'TEXTAREA' ? seg.value : seg.textContent;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'segment-editor-wrapper';
                    const textarea = document.createElement('textarea');
                    textarea.className = 'segment-editor';
                    textarea.value = text;
                    textarea.rows = 3;

                    const suggestBtn = document.createElement('button');
                    suggestBtn.innerText = "Improve";
                    suggestBtn.style.marginLeft = '10px';
                    suggestBtn.onclick = () => suggestImprovement(textarea);

                    wrapper.appendChild(textarea);
                    wrapper.appendChild(suggestBtn);
                    seg.replaceWith(wrapper);
                });
            } else {
                // This part is handled by saveEditedSegments reloading the view
            }
        }

        async function saveEditedSegments() {
            const filename = document.getElementById("noteInput").dataset.filename;
            const wrappers = document.querySelectorAll('#transcriptPreviewBox .segment-editor-wrapper');
            const originalSegments = document.querySelectorAll('#transcriptPreviewBox .transcript-segment');

            const updatedSegments = [];
            wrappers.forEach((wrapper, index) => {
                const textarea = wrapper.querySelector('textarea');
                // This assumes original segments are available in the same order before editing was toggled.
                // A more robust way would be to store original data in datasets.
                const originalSegDiv = originalSegments[index];
                updatedSegments.push({
                    text: textarea.value,
                    start: parseFloat(originalSegDiv.dataset.start),
                    end: parseFloat(originalSegDiv.dataset.end)
                });
            });

            try {
                const res = await fetch(`/api/transcript/${filename}/segments`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("accessToken") },
                    body: JSON.stringify({ segments: updatedSegments })
                });
                if (!res.ok) throw new Error("Failed to save segments");
                showToast("Segments saved successfully!", "success");
                await loadTranscriptForDetailView(filename); // Reload to exit edit mode and show changes
            } catch (err) {
                showToast("Error saving segments: " + err.message, "error");
            }
        }

        async function suggestImprovement(textarea) {
            const originalText = textarea.value;
            if (!originalText.trim()) return;
            textarea.value = "Getting suggestion...";
            try {
                const res = await fetch(`/api/ai/suggest`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("accessToken") },
                    body: JSON.stringify({ text: originalText })
                });
                if (!res.ok) throw new Error("Failed to get suggestion");
                const data = await res.json();
                textarea.value = data.suggestion || originalText;
                showToast("Suggestion applied!", "success");
            } catch (err) {
                showToast("Suggestion error: " + err.message, "error");
                textarea.value = originalText;
            }
        }

        // --- SUMMARY & QUIZ FUNCTIONS ---

        async function toggleSummary() {
            const container = document.getElementById("summaryContainer");
            const content = document.getElementById("summaryContent");
            const filename = document.getElementById("noteInput").dataset.filename;

            if (container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            content.innerHTML = '<em>Generating summary...</em>';

            try {
                const res = await fetch(`/api/transcript/${filename}/summary`, {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error('Failed to fetch summary');
                const data = await res.json();
                content.innerText = data.summary || 'No summary available.';
            } catch (err) {
                content.innerHTML = `<em style="color:red">Error: ${err.message}</em>`;
            }
        }

        async function generateFullQuiz() {
            const filename = document.getElementById("noteInput").dataset.filename;
            showToast("Generating quiz questions...", "info");
            try {
                const res = await fetch(`/api/quiz/${filename}/generate`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error('Quiz generation failed.');
                showToast("Quiz generated successfully! Click 'View Saved Quiz'.", "success");
            } catch (err) {
                showToast(`Quiz generation error: ${err.message}`, "error");
            }
        }

        async function toggleQuizPanel() {
            const panel = document.getElementById('quizViewPanel');
            const filename = document.getElementById('noteInput').dataset.filename;
            if (!filename) return;

            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                document.getElementById('quizViewFilename').innerText = `Quiz for ${filename}`;
                panel.style.display = 'block';
                await loadSavedQuiz(filename, document.getElementById('quizViewList'));
            }
        }

        async function loadSavedQuiz(filename, container) {
            container.innerHTML = "<em>Loading quiz questions...</em>";
            try {
                const res = await fetch(`/api/quiz/${filename}`, {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error('Failed to load quiz');
                const data = await res.json();
                if (!data.quiz || data.quiz.length === 0) {
                    container.innerHTML = "<p>No saved questions found for this transcript.</p>";
                    return;
                }

                container.innerHTML = "";
                data.quiz.forEach(q => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'quiz-item';
                    itemDiv.innerHTML = `
                        <strong>Question:</strong>
                        <textarea id="q-text-${q.timestamp}">${q.question}</textarea>
                        <button onclick="updateQuizQuestion('${filename}', '${q.timestamp}')">Save Edit</button>
                        <button onclick="deleteQuizQuestion('${filename}', '${q.timestamp}')">Delete</button>
                    `;
                    container.appendChild(itemDiv);
                });
            } catch (err) {
                container.innerHTML = `<p style="color:red">Error loading quiz: ${err.message}</p>`;
            }
        }

        async function updateQuizQuestion(filename, timestamp) {
            const newQuestion = document.getElementById(`q-text-${timestamp}`).value;
            if (!newQuestion.trim()) return showToast("Question cannot be empty.", "error");

            try {
                const res = await fetch(`/api/quiz/${filename}/${timestamp}`, {
                    method: 'PATCH',
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("accessToken") },
                    body: JSON.stringify({ question: newQuestion })
                });
                if (!res.ok) throw new Error('Update failed');
                showToast('Question updated!', 'success');
            } catch (err) {
                showToast(`Error updating question: ${err.message}`, 'error');
            }
        }

        async function deleteQuizQuestion(filename, timestamp) {
            if (!confirm("Are you sure you want to delete this question?")) return;
            try {
                const res = await fetch(`/api/quiz/${filename}/${timestamp}`, {
                    method: 'DELETE',
                    headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
                if (!res.ok) throw new Error('Delete failed');
                showToast('Question deleted.', 'success');
                // Reload the quiz list in the currently active view
                const quizViewList = document.getElementById('quizViewList');
                if (document.getElementById('quizViewPanel').style.display === 'block') {
                    loadSavedQuiz(filename, quizViewList);
                }
            } catch (err) {
                showToast(`Error deleting question: ${err.message}`, 'error');
            }
        }

        // --- NOTE & EXPORT FUNCTIONS ---

        async function saveNote() {
            const textarea = document.getElementById("noteInput");
            const note = textarea.value;
            const filename = textarea.dataset.filename;
            if (!filename) return;

            try {
                const res = await fetch(`/api/transcript/${filename}/note`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("accessToken") },
                    body: JSON.stringify({ note })
                });
                if (!res.ok) throw new Error("Note save failed");
                showToast("Note saved.", "success");
            } catch (err) {
                showToast("Note save error: " + err.message, "error");
            }
        }

        async function exportTranscriptAsPDF() {
            const { jsPDF } = window.jspdf;
            const transcriptBox = document.getElementById('transcriptPreviewBox');
            const filename = document.getElementById('noteInput').dataset.filename || 'transcript';
            showToast('Generating PDF...', 'info');

            try {
                const canvas = await html2canvas(transcriptBox);
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${filename}.pdf`);
            } catch (err) {
                showToast(`PDF Export Error: ${err.message}`, 'error');
            }
        }

        // --- All other existing functions (login, register, uploadFile, filterTranscripts, etc.) should follow here ---
        // For brevity, I am omitting the functions that were not changed by this update.
        // Assume all the previous functions (profile, admin, analytics, auth, etc.) are present below.

        window.onload = () => { /* Your existing onload logic */ };
        <script>
            let currentUser = null;
            let allTranscripts = [];

            function showToast(message, type = "info") {
                let bg = {success: "#4CAF50", error: "#f44336", info: "#2196F3" }[type] || "#333";
            Toastify({text: message, duration: 3000, gravity: "top", position: "right", backgroundColor: bg }).showToast();
        }

            // --- NEW/UPDATED TRANSCRIPT DETAIL & NOTE FUNCTIONS ---

            async function loadTranscriptForDetailView(filename) {
            const panel = document.getElementById("transcriptDetailPanel");
            panel.style.display = "block";
            document.getElementById("transcriptDetailFilename").innerText = filename;
            const previewBox = document.getElementById("transcriptPreviewBox");
            const noteTextarea = document.getElementById("noteInput");

            previewBox.innerHTML = "<em>Loading transcript...</em>";
            noteTextarea.value = "<em>Loading note...</em>";
            noteTextarea.dataset.filename = filename;

            try {
                const [transcriptRes, noteRes] = await Promise.all([
            fetch(`/api/transcript/${filename}`, {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                    }),
            fetch(`/api/transcript/${filename}/note`, {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                    })
            ]);

            if (!transcriptRes.ok) throw new Error("Transcript load failed");
            const transcriptData = await transcriptRes.json();

            // Populate preview area
            previewBox.innerHTML = ""; // Clear loading message
            if (transcriptData.segments && transcriptData.segments.length) {
                transcriptData.segments.forEach(seg => {
                    const div = document.createElement("div");
                    div.className = "transcript-segment";
                    div.textContent = seg.text;
                    div.dataset.start = seg.start;
                    div.dataset.end = seg.end;
                    previewBox.appendChild(div);
                });
                } else {
                previewBox.innerText = transcriptData.transcript || "[Empty]";
                }

            document.getElementById("transcriptSearchPanel").style.display = "block";
            document.getElementById("searchTranscriptInput").value = "";

            // load note
            if (!noteRes.ok && noteRes.status !== 404) throw new Error("Note load failed");
            const noteData = noteRes.ok ? await noteRes.json() : {note: "" };
            noteTextarea.value = noteData.note || "";

            } catch (err) {
                showToast("Error loading transcript or note: " + err.message, "error");
            previewBox.innerHTML = `<p style="color:red;">Failed to load details.</p>`;
            }
        }

            async function saveNote() {
            const textarea = document.getElementById("noteInput");
            const note = textarea.value.trim();
            const filename = textarea.dataset.filename;
            if (!filename) return;

            try {
                const res = await fetch(`/api/transcript/${filename}/note`, {
                method: "POST",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("accessToken"),
            "Content-Type": "application/json",
                    },
            body: JSON.stringify({note})
                });
            if (!res.ok) throw new Error("Note save failed");
            showToast("Note saved.", "success");
            } catch (err) {
                showToast("Note save error: " + err.message, "error");
            }
        }

            function getSelectedText() {
            const selection = window.getSelection();
            return selection ? selection.toString().trim() : "";
        }

            function generateQuestionFromSelection() {
            const selectedText = getSelectedText();
            if (!selectedText) {
                showToast("Highlight a transcript section first.", "info");
            return;
            }
            const questionInput = document.getElementById('questionInput');
            questionInput.value = `Explain the following from the transcript: "${selectedText}"`;
            questionInput.focus();
            window.scrollTo(0, questionInput.offsetTop - 20); // Scroll to question input
            showToast("Question populated. Press 'Ask' to submit.", "success");
        }

            function closeTranscriptDetail() {
                document.getElementById("transcriptDetailPanel").style.display = "none";
        }

            function searchWithinTranscript() {
            const query = document.getElementById('searchTranscriptInput').value.toLowerCase();
            const previewBox = document.getElementById('transcriptPreviewBox');
            const segments = previewBox.querySelectorAll('.transcript-segment');
            
            segments.forEach(seg => {
                const text = seg.textContent.toLowerCase();
            if (query && text.includes(query)) {
                seg.style.backgroundColor = '#ffff99';
                } else {
                seg.style.backgroundColor = '';
                }
            });
        }

            // --- END OF NEW FUNCTIONS ---

            // Analytics Functions
            function toggleAnalytics() {
            const panel = document.getElementById("analyticsPanel");
            panel.style.display = panel.style.display === "none" ? "block" : "none";
            if (panel.style.display === "block") loadAnalytics();
        }

            async function loadAnalytics() {
            const contentBox = document.getElementById("analyticsContent");
            contentBox.innerHTML = "<p>Loading analytics...</p>";
            try {
                const res = await fetch("/api/admin/analytics", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!res.ok) throw new Error((await res.json()).detail || 'Failed to fetch admin analytics');
            const data = await res.json();
            displayAnalytics(data);
            loadUploadsByDateChart();
            } catch (err) {
                console.error("Analytics load error:", err);
            contentBox.innerHTML = `<p>Error loading analytics: ${err.message}</p>`;
            }
        }

            function displayAnalytics(data) {
            const contentBox = document.getElementById("analyticsContent");
            contentBox.innerHTML = `
            <div class="analytics-section">
                <h4>Overall Stats</h4>
                <span class="analytics-stat"><strong>Total Users:</strong> ${data.total_users}</span>
                <span class="analytics-stat"><strong>Total Files:</strong> ${data.total_files}</span>
                <span class="analytics-stat"><strong>Total Qs:</strong> ${data.total_questions}</span>
            </div>
            <div class="analytics-section">
                <h4>Top Users (by activity)</h4>
                <canvas id="userActivityChart" height="150"></canvas>
            </div>
            `;
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
            data: {
                labels: data.top_users.map(u => u.email),
            datasets: [{
                label: 'User Activity Count',
                        data: data.top_users.map(u => u.count),
            backgroundColor: '#007BFF'
                    }]
                },
            options: {responsive: true, scales: {y: {beginAtZero: true } } }
            });
        }

            async function loadUploadsByDateChart() {
            try {
                const res = await fetch("/api/admin/stats/uploads-by-date", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!res.ok) throw new Error((await res.json()).detail || 'Failed to fetch date stats');

            const data = await res.json();
            const contentBox = document.getElementById("analyticsContent");

            const dateChartSection = document.createElement('div');
            dateChartSection.className = 'analytics-section';
            dateChartSection.innerHTML = `<h4>Uploads Per Day</h4>`;
            const canvas = document.createElement('canvas');
            canvas.id = 'uploadsByDateChart';
            canvas.height = 150;
            dateChartSection.appendChild(canvas);
            contentBox.appendChild(dateChartSection);

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
            data: {
                labels: data.map(d => d.date),
            datasets: [{
                label: 'Uploads per day',
                            data: data.map(d => d.count),
            borderColor: '#28a745',
            fill: false,
            tension: 0.1
                        }]
                    },
            options: {
                responsive: true,
            scales: {y: {beginAtZero: true, ticks: {stepSize: 1 } } }
                    }
                });
            } catch (err) {
                console.error("Date chart error:", err);
            showToast(`Error loading date chart: ${err.message}`, "error");
            }
        }

            // Walkthrough Function
            async function toggleWalkthrough() {
            const panel = document.getElementById("walkthroughPanel");
            const content = document.getElementById("walkthroughContent");
            panel.style.display = panel.style.display === "none" ? "block" : "none";

            if (panel.style.display === "block") {
                try {
                content.innerHTML = "<em>Loading...</em>";
            const res = await fetch("/api/qa-history", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                    });
            if (!res.ok) throw new Error("Failed to load Q&A history");
            const data = await res.json();

            if (!data.history || data.history.length === 0) {
                content.innerHTML = "<p><em>No Q&A history found. Ask a question to see it here.</em></p>";
            return;
                    }

                    content.innerHTML = data.history.map(q => `
            <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ccc;">
                <p><strong>Q:</strong> ${q.question}</p>
                <p><strong>A:</strong> ${q.answer}</p>
                <small><em>${new Date(q.timestamp).toLocaleString()}</em></small>
            </div>
            `).join("");

                } catch (err) {
                content.innerHTML = `<p style="color:red;">Error loading history: ${err.message}</p>`;
                }
            }
        }

            // Tag Management Functions
            async function updateTag(filename, tag) {
            try {
                const res = await fetch(`/api/transcript/${filename}/tag`, {
                method: "POST",
            headers: {
                "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("accessToken")
                    },
            body: JSON.stringify({tag})
                });

            if (!res.ok) throw new Error("Failed to update tag");
            showToast("Tag updated successfully!", "success");
            loadHistory();
            } catch (err) {
                showToast("Error updating tag: " + err.message, "error");
            }
        }

            // Profile Management Functions
            function toggleProfile() {
            const box = document.getElementById("profileBox");
            const overlay = document.getElementById("profileOverlay");
            const isVisible = box.style.display === "block";
            box.style.display = isVisible ? "none" : "block";
            overlay.style.display = isVisible ? "none" : "block";
            if (!isVisible) loadProfile();
        }

            function loadProfile() {
                document.getElementById("displayName").value = localStorage.getItem("displayName") || "";
            document.getElementById("prefDark").checked = localStorage.getItem("prefDark") === "true";
            document.getElementById("emailNotifications").checked = localStorage.getItem("emailNotifications") === "true";
        }

            function saveProfile() {
            const displayName = document.getElementById("displayName").value;
            const prefDark = document.getElementById("prefDark").checked;
            const emailNotifications = document.getElementById("emailNotifications").checked;

            localStorage.setItem("displayName", displayName);
            localStorage.setItem("prefDark", prefDark.toString());
            localStorage.setItem("emailNotifications", emailNotifications.toString());

            if (prefDark) document.body.classList.add("dark");
            else document.body.classList.remove("dark");

            if (displayName) document.getElementById("welcomeHeader").innerText = `Welcome, ${displayName}`;

            showToast("Profile saved.", "success");
            toggleProfile();
        }

            function logout() {
                localStorage.clear();
            window.location.reload();
        }

            function toggleDarkMode() {
                document.body.classList.toggle("dark");
            localStorage.setItem("prefDark", document.body.classList.contains("dark"));
        }

            function showRegister() {
                document.getElementById("loginBox").style.display = "none";
            document.getElementById("registerBox").style.display = "block";
            document.getElementById("resetBox").style.display = "none";
        }

            function showLogin() {
                document.getElementById("registerBox").style.display = "none";
            document.getElementById("loginBox").style.display = "block";
            document.getElementById("resetBox").style.display = "none";
        }

            function showReset() {
                document.getElementById("loginBox").style.display = "none";
            document.getElementById("resetBox").style.display = "block";
        }

            async function resetPassword() {
            const email = document.getElementById("resetEmail").value;
            const password = document.getElementById("newPassword").value;
            const code = document.getElementById("resetCode").value;
            try {
                const res = await fetch("/reset-password", {
                method: "POST",
            headers: {"Content-Type": "application/json" },
            body: JSON.stringify({email, password, code})
                });
            if (!res.ok) throw new Error("Reset failed");
            showToast("Password updated!", "success");
            showLogin();
            } catch (err) {
                showToast("Reset error: " + err.message, "error");
            }
        }

            async function downloadAll() {
            try {
                showToast("Preparing download...", "info");
            const response = await fetch("/api/download/all", {
                method: "GET",
            headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!response.ok) throw new Error("Download failed");
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "all_transcripts.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showToast("Download started!", "success");
            } catch (err)
            showToast("Download error: " + err.message, "error");
            }
        }

            async function loadActivityLog() {
            try {
                const res = await fetch("/api/activity-log", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!res.ok) throw new Error("Failed to load activity log");
            const data = await res.json();
            const logDiv = document.getElementById("activityLog");
            logDiv.innerHTML = "<h4>Recent Activity</h4><ul>" +
                    data.log.map(e => `<li>${e[1]} - ${e[2] || "(no file)"} by ${e[0]} @ ${new Date(e[3]).toLocaleString()}</li>`).join("") +
                "</ul>";
            } catch (err) {
                showToast("Error loading activity log: " + err.message, "error");
            }
        }

            async function loadFeedback() {
            const box = document.getElementById("feedbackList");
            box.innerHTML = "<p><em>Loading feedback...</em></p>";
            try {
                const res = await fetch("/api/feedback", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!res.ok) throw new Error("Failed to load feedback");
            const data = await res.json();
            if (!data.length) {
                box.innerHTML = "<p>No feedback found.</p>";
            return;
                }
                box.innerHTML = data.map(fb =>
            `<div style="padding: 10px; border-bottom: 1px solid #ccc;">` +
                `<strong>${fb.email}</strong> - <em>${new Date(fb.timestamp).toLocaleString()}</em>` +
                `<p>${fb.message}</p>` +
                `</div>`
            ).join("");
            } catch (err) {
                box.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

            async function submitFeedback() {
            const input = document.getElementById('feedbackInput');
            const status = document.getElementById('feedbackStatus');
            const message = input.value.trim();
            if (!message) {
                status.innerHTML = "<p style='color:red;'>Please write something.</p>";
            return;
            }
            try {
                const res = await fetch('/api/feedback', {
                method: "POST",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("accessToken"),
            "Content-Type": "application/json"
                    },
            body: JSON.stringify(message)
                });
            if (!res.ok) throw new Error("Failed to submit feedback");
            input.value = '';
            status.innerHTML = "<p style='color:green;'>Feedback submitted. Thank you!</p>";
            } catch (err) {
                status.innerHTML = `<p style='color:red;'>Error: ${err.message}</p>`;
            }
        }

            async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return showToast("Please select a file to upload.", "error");

            const formData = new FormData();
            formData.append("file", file);
            const spinner = document.getElementById("spinner");
            spinner.style.display = "inline-block";

            try {
                const res = await fetch("/upload-and-transcribe", {
                method: "POST",
            headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") },
            body: formData
                });
            if (!res.ok) {
                    const error = await res.json();
            throw new Error(error.detail || "Upload failed");
                }
            showToast("Upload and transcription successful!", "success");
            loadHistory();
            fileInput.value = "";
            } catch (err) {
                showToast("Upload error: " + err.message, "error");
            } finally {
                spinner.style.display = "none";
            }
        }

            async function askQuestion() {
            const questionInput = document.getElementById("questionInput");
            const question = questionInput.value.trim();
            if (!question) return showToast("Please enter a question.", "error");

            const answerText = document.getElementById("answerText");
            const sourcesBox = document.getElementById("sourcesBox");
            answerText.textContent = "";
            sourcesBox.innerHTML = "";
            const spinner = document.getElementById("spinner");
            spinner.style.display = "inline-block";

            try {
                const response = await fetch("/ask", {
                method: "POST",
            headers: {
                "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("accessToken")
                    },
            body: JSON.stringify({question})
                });

            if (!response.ok || !response.body) {
                    const errData = await response.json();
            throw new Error(errData.detail || "Failed to get response from server.");
                }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                    const {done, value} = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, {stream: true });
            for (const line of chunk.split("\n\n")) {
                        if (!line.startsWith("data:")) continue;
            try {
                            const payload = JSON.parse(line.slice(5));
            if (payload.type === "token") {
                answerText.textContent += payload.data;
                            } else if (payload.type === "sources") {
                payload.data.forEach(source => {
                    const block = document.createElement("div");
                    block.className = "source-block";
                    block.innerHTML = `<strong>Source:</strong> ${source.source || "Unknown"}<div class='source-text'>${source.text}</div>`;
                    sourcesBox.appendChild(block);
                });
                            }
                        } catch (e) {console.error("Error parsing stream chunk:", line); }
                    }
                }
            } catch (err) {
                showToast("Error asking question: " + err.message, "error");
            } finally {
                spinner.style.display = "none";
            questionInput.value = "";
            }
        }

            function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            fetch("/login", {
                method: "POST",
            headers: {"Content-Type": "application/json" },
            body: JSON.stringify({email, password})
            }).then(res => {
                if (!res.ok) throw new Error("Login failed");
            return res.json();
            }).then(data => {
                localStorage.setItem("accessToken", data.access_token);
            localStorage.setItem("userEmail", email);
            window.onload(); // Re-run init logic
            showToast("Login successful", "success");
            }).catch(err => {
                showToast("Login error: " + err.message, "error");
            });
        }

            function register() {
            const full_name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;
            const invite_code = document.getElementById("registerCode").value;
            fetch("/register", {
                method: "POST",
            headers: {"Content-Type": "application/json" },
            body: JSON.stringify({email, password, full_name, invite_code})
            }).then(res => {
                if (!res.ok) throw new Error("Registration failed");
            return res.json();
            }).then(() => {
                showToast("Account created! Please login.", "success");
            showLogin();
            }).catch(err => {
                showToast("Registration error: " + err.message, "error");
            });
        }

            function filterTranscripts() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const tagQuery = document.getElementById("tagSearchInput").value.toLowerCase();
            const sortBy = document.getElementById("sortSelect").value;

            let filtered = allTranscripts.filter(item => {
                const name = (typeof item === 'string' ? item : item.filename).toLowerCase();
            const tag = (typeof item === 'object' && item.tag) ? item.tag.toLowerCase() : "";
            return name.includes(query) && (!tagQuery || tag.includes(tagQuery));
            });

            if (sortBy === "oldest") filtered.reverse();

            const historyDiv = document.getElementById("transcriptHistory");
            historyDiv.innerHTML = "<h3>Transcript History</h3>";
            if (filtered.length === 0) {
                historyDiv.innerHTML += "<p>No matching transcripts found.</p>";
            } else {
                filtered.forEach(item => renderTranscriptItem(item, historyDiv));
            }
        }

            // MODIFIED RENDER FUNCTION
            function renderTranscriptItem(item, container) {
            const filename = typeof item === 'string' ? item : item.filename;
            const tag = typeof item === 'object' ? item.tag : null;
            const div = document.createElement("div");
            div.className = "history-item";
            const nameSpan = document.createElement("span");
            nameSpan.innerText = `📄 ${filename}`;

            const tagInput = document.createElement("input");
            tagInput.type = "text";
            tagInput.className = "tag-input";
            tagInput.placeholder = "Add tag...";
            tagInput.value = tag || "";
            tagInput.onkeypress = (e) => { if (e.key === 'Enter') updateTag(filename, tagInput.value); };

            const tagButton = document.createElement("button");
            tagButton.innerText = "Tag";
            tagButton.onclick = () => updateTag(filename, tagInput.value);

            const tagsDisplay = document.createElement("div");
            tagsDisplay.className = "tags-display";
            if (tag) {
                const tagBadge = document.createElement("span");
            tagBadge.className = "tag-badge";
            tagBadge.innerText = tag;
            tagsDisplay.appendChild(tagBadge);
            }

            // Replaced Preview with View Details
            const viewDetailsBtn = document.createElement("button");
            viewDetailsBtn.innerText = "View Details";
            viewDetailsBtn.onclick = () => loadTranscriptForDetailView(filename);

            const shareBtn = document.createElement("button");
            shareBtn.innerText = "Share";
            shareBtn.onclick = () => {
                const link = `${window.location.origin}/static/view.html?file=${encodeURIComponent(filename)}`;
            navigator.clipboard.writeText(link);
            showToast("Shareable link copied!", "info");
            };

            const downloadBtn = document.createElement("button");
            downloadBtn.innerText = "Download";
            downloadBtn.onclick = () => {window.location.href = `/api/download/${filename}?token=${localStorage.getItem("accessToken")}`; };

            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "Delete";
            deleteBtn.onclick = async () => {
                if (confirm(`Are you sure you want to delete ${filename}?`)) {
                    try {
                        const res = await fetch(`/api/delete/${filename}`, {
                method: "DELETE",
            headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                        });
            if (!res.ok) throw new Error("Delete failed");
            loadHistory();
            showToast(`${filename} deleted.`, "info");
            closeTranscriptDetail(); // Close detail panel if the deleted file was open
                    } catch (err) {
                showToast("Delete error: " + err.message, "error");
                    }
                }
            };

            div.appendChild(nameSpan);
            div.appendChild(tagInput);
            div.appendChild(tagButton);
            div.appendChild(viewDetailsBtn); // Using the new button
            div.appendChild(shareBtn);
            div.appendChild(downloadBtn);
            div.appendChild(deleteBtn);
            div.appendChild(tagsDisplay);

            container.appendChild(div);
        }

            async function loadHistory() {
            try {
                const res = await fetch("/api/history", {
                headers: {"Authorization": "Bearer " + localStorage.getItem("accessToken") }
                });
            if (!res.ok) throw new Error("Failed to load history");
            const data = await res.json();
            allTranscripts = data.files || [];
            filterTranscripts();
            } catch (err) {
                showToast("Error loading history: " + err.message, "error");
            }
        }

        window.onload = () => {
            const token = localStorage.getItem("accessToken");
            if (token) {
                currentUser = localStorage.getItem("userEmail") || "user";
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("appUI").style.display = "block";

            const displayName = localStorage.getItem("displayName");
            document.getElementById("welcomeHeader").innerText = `Welcome, ${displayName || currentUser}`;

                if (currentUser === "patrick@gridllc.net") {
                    document.getElementById("adminPanel").style.display = "block";
                    document.getElementById("analyticsToggle").style.display = "inline-block";
                } else {
                    document.getElementById("analyticsToggle").style.display = "none";
                }

                if (localStorage.getItem("prefDark") === "true") {
                    document.body.classList.add("dark");
                }
                loadHistory();
            } else {
                document.getElementById("loginBox").style.display = "block";
                document.getElementById("appUI").style.display = "none";
                document.getElementById("registerBox").style.display = "none";
            }
        };
    </script>

</body>

</html>