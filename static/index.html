<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartAI Audio Transcriber</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #333;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 12px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .toast.show {
      opacity: 1;
    }
    @media screen and (max-width: 600px) {
      body { padding: 10px; }
      button, input { width: 100%; margin-top: 10px; }
    }
  </style>
</head>
<body>
  <h1>SmartAI Audio Transcriber</h1>

  <input type="file" id="audioFile" />
  <button onclick="uploadAndTranscribe(event)">Upload and Transcribe</button>
  <div class="spinner" id="uploadSpinner"></div>

  <hr />

  <input type="text" id="searchInput" placeholder="Search transcripts..." oninput="filterHistory()" style="margin-bottom: 12px; width: 100%; padding: 6px;" />

  <h2>Transcript History</h2>
  <div id="history">Loading...</div>

  <div class="toast" id="toast"></div>

  <script>
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast show";
      setTimeout(() => toast.className = "toast", 3000);
    }

    async function uploadAndTranscribe(event) {
      const fileInput = document.getElementById("audioFile");
      const file = fileInput.files[0];
      const button = event.target;
      const spinner = document.getElementById("uploadSpinner");

      if (!file) {
        showToast("Please choose a file first.");
        return;
      }

      button.disabled = true;
      button.textContent = "Uploading...";
      spinner.style.display = "inline-block";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("/upload-and-transcribe", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          showToast("Transcription complete!");
          loadHistory();
        } else {
          showToast("Error: " + result.error);
        }
      } catch (err) {
        showToast("Upload failed.");
        console.error(err);
      }

      button.disabled = false;
      button.textContent = "Upload and Transcribe";
      spinner.style.display = "none";
    }

    async function loadHistory() {
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "<em>Loading history...</em>";

      try {
        const response = await fetch("/api/history");
        if (!response.ok) throw new Error("Failed to fetch history.");
        const data = await response.json();
        historyDiv.innerHTML = "";

        data.transcripts.forEach(item => {
          const div = document.createElement("div");
          div.className = "transcript-entry";
          div.style.marginBottom = "12px";

          const timestamp = new Date(item.created_at).toLocaleString();

          const previewBtn = document.createElement("button");
          previewBtn.textContent = "Preview";
          previewBtn.onclick = () => togglePreview(item.filename);

          const audio = document.createElement("audio");
          audio.src = `/uploads/${item.filename}`;
          audio.controls = true;
          audio.style.display = "block";
          audio.style.marginTop = "6px";

          const downloadBtn = document.createElement("a");
          downloadBtn.href = `/transcripts/${item.filename}.txt`;
          downloadBtn.download = item.filename + ".txt";
          downloadBtn.textContent = "Download";
          downloadBtn.style.marginLeft = "8px";

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.style.marginLeft = "8px";
          deleteBtn.onclick = () => deleteTranscript(item.filename);

          const previewContainer = document.createElement("div");
          previewContainer.id = `preview-${item.filename}`;
          previewContainer.style.display = "none";
          previewContainer.style.whiteSpace = "pre-wrap";
          previewContainer.style.marginTop = "8px";
          previewContainer.style.paddingLeft = "12px";
          previewContainer.style.borderLeft = "2px solid #ccc";

          div.innerHTML = `<strong>${item.filename}</strong> â€” ${timestamp}`;
          div.appendChild(previewBtn);
          div.appendChild(downloadBtn);
          div.appendChild(deleteBtn);
          div.appendChild(audio);
          div.appendChild(previewContainer);

          historyDiv.appendChild(div);
        });
      } catch (err) {
        historyDiv.innerHTML = "<em>Failed to load history.</em>";
        console.error(err);
      }
    }

    function filterHistory() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll(".transcript-entry").forEach(entry => {
        entry.style.display = entry.textContent.toLowerCase().includes(query) ? "block" : "none";
      });
    }

    async function togglePreview(filename) {
      const container = document.getElementById(`preview-${filename}`);
      if (container.style.display === "block") {
        container.style.display = "none";
        container.textContent = "";
        return;
      }

      try {
        const response = await fetch(`/transcripts/${filename}.txt`);
        const text = await response.text();
        container.textContent = text;
        container.style.display = "block";
      } catch (err) {
        container.textContent = "Failed to load transcript.";
        container.style.display = "block";
      }
    }

    async function deleteTranscript(filename) {
      if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

      try {
        const response = await fetch(`/api/delete/${filename}`, {
          method: "DELETE",
        });

        if (response.ok) {
          showToast("Deleted successfully");
          loadHistory();
        } else {
          showToast("Failed to delete transcript.");
        }
      } catch (err) {
        showToast("Error deleting transcript.");
        console.error(err);
      }
    }

    loadHistory();
  </script>
</body>
</html>